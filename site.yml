---
- name: Install Rails
  hosts: all
  remote_user: deployer
  become: true
  gather_facts: true
  pre_tasks:
    # - name: fix update
    #   raw: sudo date -s "$(curl -s --head http://google.com | grep ^Date: | sed 's/Date: //g') -0500"
    - name: installing ansible dependencies
      raw: sudo apt-get -y install python3 python3-simplejson python3-apt python python-simplejson python-apt

  vars:
    #sidekiq_token:
    datadog_api_key: 
    datadog_config:
      tags: "test_ansible"
      log_level: INFO
      apm_enabled: "true" # has to be set as a string
      logs_enabled: true  # log collection is available on agent 6
    datadog_config_ex:
      trace.config:
        env: test_ansible
      trace.concentrator:
        extra_aggregators: version
    datadog_checks:
      nginx:
        init_config:
        instances:
          - nginx_status_url: http://localhost/nginx_status/
      mcache:
        init_config:
        instances:
          - url: localhost
      redisdb:
        init_config:
        instances:
          - host: localhost
            port: 6379

  roles:
    - common
    - {
        role: rvm_io.ruby,
        tags: ruby,
        rvm1_rubies: ['ruby-2.3'],
        rvm1_install_flags: '--auto-dotfiles --user-install',
        rvm1_user: deployer
      }
    - ruby_config
    - nginx_passenger
    - redis
    - memcached
    - { role: Datadog.datadog, become: yes }
